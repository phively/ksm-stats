---
title: "Email statistics"
output:
  html_notebook:
    code_folding: hide
    toc: TRUE
    toc_float:
      collapsed: FALSE
---

<style>
#header .btn-group {
    display: none;
}
</style>

```{r setup, echo = FALSE, message = FALSE, warning = FALSE}
# Libraries
library(tidyverse)
library(lubridate)
library(readxl)
library(wranglR)
library(knitr)

# Set to FALSE to hide all code chunks when rendering the document
opts_chunk$set(echo = FALSE)

# Load data from last time
load('data/dat_agg.Rdata')
```

# Background and definitions

```{r, warning = FALSE}
# Email summary data from iModules
dat_summary_table <- read_xlsx(
  'data/Ranking Survey Email Metrics 18-19.xlsx'
  , sheet = 2
  , col_types = c('text', 'text', 'text', 'text', 'date', 'text', 'numeric', 'numeric', 'numeric', 'numeric', 'numeric', 'numeric', 'numeric', 'numeric', 'text')
) %>%
  filter(!is.na(`Email Type`) & Publication != 'Publication') %>%
  # Better column names
  rename(
    Drilldown = `Drill Down Data Available?`
  ) %>%
  # Format percents
  mutate(
    `Open Rate` = `Open Rate` %>% round(2) %>% scales::percent()
    , CTR = CTR %>% round(2) %>% scales::percent()
  )
```

iModules is the system used to send mass emails to Northwestern constituents, including alumni. Detailed email recipient, bounce, open, and click data is available for 480 days after an email is sent; after that time, only summary statistics are available.

The metrics are defined as follows:

* **Delivered** = 200 HTTP status code response from server, e.g. the request was fulfilled (*delivered does not imply inbox placement*)
* **Bounces** = email addresses that could not be successfully delivered to the recipient's inbox for some reason
* **Open** = tracking pixel loaded (*implying that image blocking or plain-text email clients leads to underreporting of opens*)
* **Click** = number of times any recipient clicks on any link within the email where tracking is active (*excluding the unsubscribe link*)

Summary statistics for each publication appear below. Looking at the email send dates, detailed information is available for just `r dat_summary_table %>% filter(Drilldown == 'Y') %>% nrow() %>% I()` of the `r dat_summary_table %>% nrow() %>% I()` emails sent (`Drilldown == 'Y'`).

# iModules summary statistics

## Businessweek

```{r}
dat_summary_table %>%
  filter(Publication == 'Businessweek') %>%
  select(-Publication, -`Time Sent`) %>%
  kable()
```

## Economist

```{r}
dat_summary_table %>%
  filter(Publication == 'Economist') %>%
  select(-Publication, -`Time Sent`) %>%
  kable()
```

## Financial Times

```{r}
dat_summary_table %>%
  filter(Publication == 'Financial Times') %>%
  select(-Publication, -`Time Sent`) %>%
  kable()
```

## Forbes

```{r}
dat_summary_table %>%
  filter(Publication == 'Forbes') %>%
  select(-Publication, -`Time Sent`) %>%
  kable()
```

Forbes email metrics are not available, as the emails were sent through Outlook rather than iModules (recipients had personalized links).

Overall, the bounce rates are surprisingly low, and the open/click rates quite high.

# Computed summary statistics

As a point of comparison, I pulled a full class list from the database. Now, the unit of analysis is individuals rather than emails. Individuals are categorized by the set of emails received, e.g. Economist 2018 FT is full-time 2018 graduates emailed about the Economist.

If an individual opened either an initial email or a reminder, I counted that as an open; the same goes for clicks. Note that raw counts will be different, as non-alumni recipients (such as KSM staff) are filtered out, unlike in the summary statistics above.

```{r}
# Summary table function
email_summary_table <- function(data) {
  data %>%
    summarize(
      n = length(ID_NUMBER)
      , sent = sum(ifelse(n_sent > 0, 1, 0))
      , bounced = sum(ifelse(n_bounced > 0, 1, 0))
      , opened = sum(ifelse(n_opened_or_clicked > 0, 1, 0))
      , clicked = sum(ifelse(n_clicks > 0, 1, 0))
    ) %>% mutate(
      sent_pct = scales::percent(sent / n)
      , open_pct = scales::percent(opened / sent)
      , clicked_pct = scales::percent(clicked / (opened + 1E-100))
    )
}
```
```{r}
# Summary table metrics
dat_agg %>% group_by(email_group) %>% email_summary_table()
```

Drilling down into this None group:

```{r}
dat_agg %>%
  filter(email_group == 'None') %>%
  group_by(FIRST_MASTERS_YEAR, PROGRAM_GROUP) %>%
  summarise(n = length(ID_NUMBER))
```

Adding these groups to the above table yields the following.

```{r}
dat_agg <- dat_agg %>% mutate(
  email_group_filled = case_when(
    as.character(email_group) != 'None' ~ as.character(email_group)
    , PROGRAM_GROUP == 'EMBA' ~ 'Financial Times 2016 EMBA'
    , FIRST_MASTERS_YEAR == 2013 ~ 'Businessweek 2013 FT'
    , FIRST_MASTERS_YEAR == 2016 ~ 'Financial Times 2016 FT'
    , FIRST_MASTERS_YEAR == 2018 ~ 'Economist 2018 FT'
    , TRUE ~ 'None'
  ) %>% as.factor()
)
```
```{r}
dat_agg %>% group_by(email_group_filled) %>% email_summary_table()
```

It's possible that link tracking was not enabled for Financial Times and the captured clicks were to non-survey links.

# Email address analysis

Just because an email was received doesn't mean it went to the individual's inbox (spam filters) or or even to an account still being checked (old address). I'd like to look at opens as a function of email address status (per the database) and email update date.

First, is the email sent to in iModules the same as the person's current preferred email address in the database?

```{r}
dat_agg %>% group_by(email_group_filled, same_email) %>% email_summary_table()
```

```{r}
dat_agg %>%
  ggplot(aes(x = email_group_filled, y = n_opened_or_clicked, color = same_email)) +
  geom_boxplot()
```

There appears to be a strong main effect for `same_email == TRUE`. Also note that all bounces, and not sent, emails are ones that weren't sent to the preferred email address per the database.

Other potentially important variables could be the email address status and date last updated.

```{r, rows.print = 100}
dat_agg %>% group_by(email_group_filled, send_email_status) %>% email_summary_table()
```

Again, note that emails not from the database have the worst performance (with a few exceptions due to expected small-sample variance).



Plugging this all into a quick and simple model:

```{r}
dat_agg %>% glm(
  ~ email_group_filled + same_email
  , data = .
  , family = binomial()
)
```

